<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebCAT Demo</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    label{display:flex;gap:8px;align-items:center}
    input,select,button{padding:6px 10px}
    pre{background:#111;color:#ddd;padding:12px;border-radius:8px;overflow:auto;max-height:40vh}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px}
    .grid{display:grid;grid-template-columns:170px 1fr;gap:6px 10px}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;font-weight:600}
    .pill.rx{background:#e7f3ff;color:#004c99}
    .pill.tx{background:#ffe7e7;color:#9b0000}
    .danger{border:1px solid #c00;color:#c00;background:#fff}
    .ok{border:1px solid #0a0;color:#0a0;background:#fff}
    .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h2>WebCAT Demo</h2>

  <div class="row">
    <label>Driver
      <select id="driver"></select>
    </label>

    <label>Baud
      <select id="baud"></select>
    </label>

    <label id="addrWrap">Addr (hex)
      <input id="addr" value="A2" maxlength="2" />
    </label>

    <label>Poll (ms)
      <input id="poll" type="number" value="200" min="20" step="10" />
    </label>

    <button id="connect">Connect (Picker)</button>
    <button id="autoconnect" class="ok">Auto-Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
    <button id="stop" disabled>Stop Poll</button>
  </div>

  <div class="row">
    <div class="card" style="min-width:460px;">
      <div class="grid">
        <div><b>PTT</b></div><div id="ptt">—</div>
        <div><b>Freq</b></div><div id="freq">—</div>
        <div><b>Mode</b></div><div id="mode">—</div>
        <div><b>S-meter</b></div><div id="smeter">—</div>
        <div><b>SWR</b></div><div id="swr">—</div>
        <div><b>PO</b></div><div id="po">—</div>
        <div><b>Vd</b></div><div id="vd">—</div>
        <div><b>Id</b></div><div id="id">—</div>
        <div><b>TX Power</b></div><div id="txpwr">—</div>
        <div><b>Compression</b></div><div id="comp">—</div>
        <div><b>Filter BW</b></div><div id="fbw">—</div>
        <div><b>Noise Blanker</b></div><div id="nb">—</div>
        <div><b>Auto Notch</b></div><div id="notch">—</div>
        <div><b>Preamp</b></div><div id="preamp">—</div>
        <div><b>AGC</b></div><div id="agc">—</div>
        <div><b>Monitor</b></div><div id="mon">—</div>
        <div><b>VFO Lock</b></div><div id="lock">—</div>
        <div><b>Tuning Step</b></div><div id="tstep">—</div>
        <div><b>ATU Status</b></div><div id="atu">—</div>
        <div><b>Meter Type</b></div><div id="mtype">—</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Set MHz <input id="setMHz" type="number" step="0.000001" value="146.520" style="width:120px" /></label>
        <button id="setFreq">Set Freq</button>

        <label>Mode
          <select id="setMode">
            <option value="FM">FM</option>
            <option value="AM">AM</option>
            <option value="USB">USB</option>
            <option value="LSB">LSB</option>
            <option value="CW">CW</option>
            <option value="CWR">CWR</option>
            <option value="DIG">DIG</option>
            <option value="PKT">PKT</option>
            <option value="FM-N">FM-N</option>
            <option value="DATA-USB">DATA-USB</option>
            <option value="DATA-LSB">DATA-LSB</option>
            <option value="C4FM">C4FM</option>
          </select>
        </label>
        <button id="applyMode">Set Mode</button>

        <button id="pttOn" class="danger">PTT ON</button>
        <button id="pttOff">PTT OFF</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>TX Power <input id="setPwr" type="range" min="0" max="255" value="100" style="width:100px" /></label>
        <button id="applyPwr">Apply</button>

        <label>Compression <input id="setComp" type="range" min="0" max="255" value="0" style="width:100px" /></label>
        <button id="applyComp">Apply</button>

        <label>Filter BW <input id="setFBW" type="range" min="0" max="255" value="128" style="width:100px" /></label>
        <button id="applyFBW">Apply</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Noise Blanker <input id="setNB" type="range" min="0" max="255" value="0" style="width:100px" /></label>
        <button id="applyNB">Apply</button>

        <label>Preamp
          <select id="setPreamp">
            <option value="0">Off</option>
            <option value="1">+10 dB</option>
            <option value="2">-10 dB</option>
            <option value="3">-20 dB</option>
          </select>
        </label>
        <button id="applyPreamp">Apply</button>

        <label>AGC
          <select id="setAGC">
            <option value="0">Fast</option>
            <option value="1">Mid</option>
            <option value="2">Slow</option>
          </select>
        </label>
        <button id="applyAGC">Apply</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Auto Notch <input id="setAutoNotch" type="checkbox" /></label>
        <button id="applyAutoNotch">Apply</button>

        <label>Monitor <input id="setMon" type="range" min="0" max="255" value="0" style="width:100px" /></label>
        <button id="applyMon">Apply</button>

        <label>VFO Lock <input id="setLock" type="checkbox" /></label>
        <button id="applyLock">Apply</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <label>Tuning Step
          <select id="setTstep">
            <option value="0">1 Hz</option>
            <option value="1">10 Hz</option>
            <option value="2">100 Hz</option>
            <option value="3">1 kHz</option>
          </select>
        </label>
        <button id="applyTstep">Apply</button>

        <label>Meter Type
          <select id="setMType">
            <option value="0">S-meter</option>
            <option value="1">SWR</option>
            <option value="2">Power Out</option>
          </select>
        </label>
        <button id="applyMType">Apply</button>

        <button id="atuTune" class="ok">ATU Tune</button>
      </div>

      <div class="muted" id="status">Not connected.</div>
    </div>

    <div class="card" style="flex:1;min-width:360px;">
      <div class="row" style="margin:0 0 6px 0;">
        <b>Log</b>
        <button id="clear" style="margin-left:auto;">Clear</button>
      </div>
      <pre id="log"></pre>
    </div>
  </div>

  <!-- Base library -->
  <script src="./webcat-base.js"></script>
  <!-- Drivers you want -->
  <script src="./drivers/webcat-icom-ic7300.js"></script>
  <script src="./drivers/webcat-icom-ic9700.js"></script>
  <script src="./drivers/webcat-yaesu-ft991a.js"></script>
  <script src="./drivers/webcat-yaesu-ft857d.js"></script>

  <script>
    const RS = window.WebCAT;
    const store = new RS.SettingsStore('radio_serial_demo');

    const el = (id) => document.getElementById(id);
    const logEl = el('log');

    function log(line){
      const ts = new Date().toISOString().slice(11,23);
      logEl.textContent += `[${ts}] ${line}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(s){ el('status').textContent = s; }

    // Populate driver dropdown
    const drivers = RS.listDrivers();
    for (const d of drivers) {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.label || d.id;
      el('driver').appendChild(opt);
    }

    // Restore UI
    const saved = store.loadUI() || {};
    if (saved.driverId) el('driver').value = saved.driverId;
    if (saved.pollMs) el('poll').value = saved.pollMs;
    if (saved.addrHex) el('addr').value = saved.addrHex;

    function refreshBaudAndAddr() {
      const meta = RS.getDriverMeta(el('driver').value) || {};
      const allowed = meta.allowedBauds || RS.COMMON_BAUDS;
      const def = meta.defaultBaud || allowed[0];

      // baud dropdown
      el('baud').innerHTML = '';
      for (const b of allowed) {
        const o = document.createElement('option');
        o.value = String(b);
        o.textContent = String(b);
        el('baud').appendChild(o);
      }
      // Use driver's defaultBaud, not saved value (prevents wrong baud from previous driver)
      el('baud').value = String(def);

      // addr
      if (meta.needsAddr) {
        el('addrWrap').style.display = '';
      } else {
        el('addrWrap').style.display = 'none';
      }
    }
    refreshBaudAndAddr();

    el('driver').addEventListener('change', () => {
      refreshBaudAndAddr();
      persist();
    });

    ['baud','poll','addr'].forEach(id => el(id).addEventListener('change', persist));

    function persist(){
      store.saveUI({
        driverId: el('driver').value,
        baud: parseInt(el('baud').value,10),
        pollMs: parseInt(el('poll').value,10),
        addrHex: el('addr').value.toUpperCase().replace(/^0X/,'').slice(0,2)
      });
    }

    let radio = null;

    function render(state){
      el('ptt').innerHTML = (state.ptt==null) ? '—' : (state.ptt ? '<span class="pill tx">TX</span>' : '<span class="pill rx">RX</span>');
      el('freq').textContent = state.freqHz ? (state.freqHz/1e6).toFixed(6)+' MHz' : '—';
      el('mode').textContent = state.mode || '—';
      el('smeter').textContent = (state.smeterRaw!=null) ? `${state.smeterRaw}/255` : '—';
      el('swr').textContent = (state.swr && state.swr.swr!=null) ? state.swr.swr.toFixed(2) : (state.extras?.hiSWR ? 'HI SWR' : '—');
      el('po').textContent = state.po?.watts!=null ? Math.round(state.po.watts)+' W' : (state.po?.raw!=null ? state.po.raw+'/255' : '—');
      el('vd').textContent = state.vd?.volts!=null ? state.vd.volts.toFixed(2)+' V' : (state.vd?.raw!=null ? state.vd.raw+'/255' : '—');
      el('id').textContent = state.id?.amps!=null ? state.id.amps.toFixed(2)+' A' : (state.id?.raw!=null ? state.id.raw+'/255' : '—');
      
      // New feature displays
      el('txpwr').textContent = (state.txpwr?.raw!=null) ? `${state.txpwr.raw}/255` : '—';
      el('comp').textContent = (state.compression?.raw!=null) ? `${state.compression.raw}/255` : '—';
      el('fbw').textContent = (state.filterbw?.raw!=null) ? `${state.filterbw.raw}/255` : '—';
      el('nb').textContent = (state.nb?.raw!=null) ? `${state.nb.raw}/255` : '—';
      el('notch').textContent = (state.autonotch?.raw!=null) ? (state.autonotch.raw ? 'ON' : 'OFF') : '—';
      
      const preampMap = { 0: 'Off', 1: '+10dB', 2: '-10dB', 3: '-20dB' };
      el('preamp').textContent = (state.preamp?.raw!=null) ? preampMap[state.preamp.raw] || state.preamp.raw : '—';
      
      const agcMap = { 0: 'Fast', 1: 'Mid', 2: 'Slow' };
      el('agc').textContent = (state.agc?.raw!=null) ? agcMap[state.agc.raw] || state.agc.raw : '—';
      
      el('mon').textContent = (state.monitor?.raw!=null) ? `${state.monitor.raw}/255` : '—';
      el('lock').textContent = (state.vfolock?.on!=null) ? (state.vfolock.on ? 'LOCKED' : 'Unlocked') : '—';
      
      const stepMap = { 0: '1Hz', 1: '10Hz', 2: '100Hz', 3: '1kHz' };
      el('tstep').textContent = (state.tuningstep?.step!=null) ? stepMap[state.tuningstep.step] || state.tuningstep.step : '—';
      
      const atuMap = { 0: 'Idle', 1: 'Tuning', 2: 'Tuned', 3: 'Memory' };
      el('atu').textContent = (state.atu?.status!=null) ? atuMap[state.atu.status] || state.atu.status : '—';
      
      const mtypeMap = { 0: 'S-meter', 1: 'SWR', 2: 'Power' };
      el('mtype').textContent = (state.metertype?.meterType!=null) ? mtypeMap[state.metertype.meterType] : '—';
      
      // Update input fields to match radio state
      if (state.freqHz) el('setMHz').value = (state.freqHz / 1e6).toFixed(6);
      if (state.mode) el('setMode').value = state.mode;
      if (state.txpwr?.raw!=null) el('setPwr').value = state.txpwr.raw;
      if (state.compression?.raw!=null) el('setComp').value = state.compression.raw;
      if (state.filterbw?.raw!=null) el('setFBW').value = state.filterbw.raw;
      if (state.nb?.raw!=null) el('setNB').value = state.nb.raw;
      if (state.preamp?.raw!=null) el('setPreamp').value = state.preamp.raw;
      if (state.agc?.raw!=null) el('setAGC').value = state.agc.raw;
      if (state.monitor?.raw!=null) el('setMon').value = state.monitor.raw;
      if (state.vfolock?.on!=null) el('setLock').checked = state.vfolock.on;
      if (state.tuningstep?.step!=null) el('setTstep').value = state.tuningstep.step;
      if (state.metertype?.meterType!=null) el('setMType').value = state.metertype.meterType;
    }

    async function connect(usePicker){
      persist();
      const ui = store.loadUI() || {};
      const driverId = ui.driverId || el('driver').value;
      const baud = ui.baud || parseInt(el('baud').value,10);
      const pollMs = ui.pollMs || parseInt(el('poll').value,10);
      const meta = RS.getDriverMeta(driverId) || {};

      // driver options (addr only for Icom)
      const driverOptions = {};
      if (meta.needsAddr) driverOptions.addrHex = ui.addrHex || el('addr').value;

      radio = new RS.RadioController({ driverId, driverOptions, store });
      radio.on('log', log);
      radio.on('update', render);
      radio.on('connected', () => setStatus('Connected. Auto-polling...'));
      radio.on('disconnected', () => setStatus('Disconnected.'));
      radio.on('error', (e) => setStatus('Error: '+(e?.message||e)));

      if (usePicker) await radio.connectWithPicker({ baudRate: baud, rememberPort: true });
      else await radio.connectRemembered({ baudRate: baud });

      // Auto poll
      radio.startPolling(pollMs);

      // Display initial state immediately
      render(radio.state);

      el('connect').disabled = true;
      el('autoconnect').disabled = true;
      el('disconnect').disabled = false;
      el('stop').disabled = false;
    }

    el('connect').addEventListener('click', () => connect(true).catch(e=>alert(e.message||e)));
    el('autoconnect').addEventListener('click', () => connect(false).catch(e=>alert(e.message||e)));

    el('disconnect').addEventListener('click', async () => {
      if (!radio) return;
      await radio.disconnect();
      radio = null;
      el('connect').disabled = false;
      el('autoconnect').disabled = false;
      el('disconnect').disabled = true;
      el('stop').disabled = true;
    });

    el('stop').addEventListener('click', () => {
      if (!radio) return;
      radio.stopPolling();
      setStatus('Polling stopped.');
      el('stop').disabled = true;
    });

    el('setFreq').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      await radio.setFrequencyMHz(el('setMHz').value);
    });

    el('applyMode').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      await radio.setMode(el('setMode').value);
    });

    el('pttOn').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      await radio.setPTT(true);
    });

    el('pttOff').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      await radio.setPTT(false);
    });

    // New feature controls
    el('applyPwr').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const val = parseInt(el('setPwr').value, 10);
      await radio.sendCommand(radio.driver.cmdSetTXPower(val));
    });

    el('applyComp').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const val = parseInt(el('setComp').value, 10);
      await radio.sendCommand(radio.driver.cmdSetCompression(val));
    });

    el('applyFBW').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const val = parseInt(el('setFBW').value, 10);
      await radio.sendCommand(radio.driver.cmdSetFilterBW(val));
    });

    el('applyNB').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const val = parseInt(el('setNB').value, 10);
      await radio.sendCommand(radio.driver.cmdSetNoiseBlanker(val));
    });

    el('applyAutoNotch').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const on = el('setAutoNotch').checked;
      await radio.sendCommand(radio.driver.cmdSetAutoNotch(on));
    });

    el('applyPreamp').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const level = parseInt(el('setPreamp').value, 10);
      await radio.sendCommand(radio.driver.cmdSetPreamp(level));
    });

    el('applyAGC').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const mode = parseInt(el('setAGC').value, 10);
      await radio.sendCommand(radio.driver.cmdSetAGC(mode));
    });

    el('applyMon').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const val = parseInt(el('setMon').value, 10);
      await radio.sendCommand(radio.driver.cmdSetMonitor(val));
    });

    el('applyLock').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const on = el('setLock').checked;
      await radio.sendCommand(radio.driver.cmdSetVFOLock(on));
    });

    el('applyTstep').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const step = parseInt(el('setTstep').value, 10);
      await radio.sendCommand(radio.driver.cmdSetTuningStep(step));
    });

    el('applyMType').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      const type = parseInt(el('setMType').value, 10);
      await radio.sendCommand(radio.driver.cmdSetMeterType(type));
    });

    el('atuTune').addEventListener('click', async () => {
      if (!radio) return alert('Not connected');
      await radio.sendCommand(radio.driver.cmdSetATUTune());
    });

    el('clear').addEventListener('click', () => logEl.textContent = '');
  </script>
</body>
</html>
