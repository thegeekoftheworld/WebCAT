<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebCAT - Ham Radio Control</title>
  <!-- Prevent accidental page reloads -->
  <script>
    (function() {
      // Intercept reload attempts
      window.location.reload = function() {
        console.warn('‚ö†Ô∏è Page reload prevented while radio is connected');
        return;
      };
      
      // Intercept location changes
      window.location.replace = function(url) {
        console.warn('‚ö†Ô∏è Navigation prevented:', url);
        return;
      };
      
      // Warn on beforeunload
      window.addEventListener('beforeunload', function(e) {
        if (document.querySelector('[data-radio-connected="true"]')) {
          e.preventDefault();
          console.warn('‚ö†Ô∏è Navigation attempt blocked - radio still connected');
          return;
        }
      });
    })();
  </script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="tools/mock-serial.js"></script>
  <script src="components/radio-panel.js"></script>
  <script src="components/qso-form.js"></script>
  <script src="components/waterfall-panel.js"></script>
  <script src="components/console-panel.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #0a0e1a; color: #e5e7f0; }
    
    #app { max-width: 1200px; margin: 0 auto; padding: 16px; }
    
    /* Header */
    .header { 
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; 
      background: linear-gradient(135deg, #0f1a2e 0%, #1a1f3a 100%);
      padding: 16px 20px; border-radius: 12px; border: 1px solid #1a2847;
    }
    .header h1 { margin: 0; font-size: 24px; letter-spacing: -0.5px; }
    .status-text { color: #8b95aa; font-size: 14px; }
    
    /* Mode Indicator Bar */
    .mode-bar {
      display: flex; gap: 12px; margin-bottom: 16px; padding: 12px 16px;
      background: #111827; border: 1px solid #1a2847; border-radius: 10px;
      align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    .mode-item {
      display: flex; align-items: center; gap: 8px; font-size: 13px;
    }
    .mode-value { font-weight: 600; color: #3a9eff; }
    .mode-sep { color: #3a4a5f; }
    
    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #1a2847; padding-bottom: 0; }
    .tab-btn { 
      padding: 12px 16px; border: none; background: transparent; color: #8b95aa; cursor: pointer;
      font-size: 14px; font-weight: 500; border-bottom: 3px solid transparent; margin-bottom: -2px;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #c5cdd8; }
    .tab-btn.active { color: #3a9eff; border-bottom-color: #3a9eff; }
    
    /* Panels */
    .panel { background: #0f1724; border: 1px solid #1a2847; border-radius: 10px; padding: 20px; }
    
    /* Setup Section (collapsed by default in simple mode) */
    .radio-setup {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
      background: #0a0e1a; border: 1px solid #1a2847; border-radius: 8px; padding: 12px;
      margin-bottom: 16px;
    }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 11px; color: #8b95aa; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    input, select { 
      padding: 8px 12px; border-radius: 6px; border: 1px solid #1a2847; background: #0a0e1a; 
      color: #e5e7f0; font-size: 13px; transition: border-color 0.2s;
    }
    input:focus, select:focus { outline: none; border-color: #3a9eff; }
    
    /* Main Radio Display */
    .radio-display {
      background: linear-gradient(135deg, rgba(30, 58, 120, 0.3) 0%, rgba(12, 20, 36, 0.3) 100%);
      border: 2px solid #1a3a6b; border-radius: 12px; padding: 24px;
    }
    .freq-display { 
      font-size: 48px; font-weight: 700; letter-spacing: -2px; margin-bottom: 8px;
      font-variant-numeric: tabular-nums; color: #3a9eff;
    }
    .freq-sub { display: flex; gap: 20px; margin-bottom: 20px; font-size: 13px; color: #8b95aa; }
    .freq-sub-item { display: flex; flex-direction: column; gap: 2px; }
    .freq-sub-value { color: #c5cdd8; font-weight: 600; }
    
    /* Frequency Adjustment Grid */
    .freq-buttons { 
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;
    }
    .freq-btn { 
      padding: 10px 8px; border-radius: 8px; border: 1px solid #1a3a6b; background: #0a1726;
      color: #c5cdd8; cursor: pointer; font-size: 12px; font-weight: 500;
      transition: all 0.15s; touch-action: manipulation;
    }
    .freq-btn:active { transform: scale(0.95); background: #1a2847; }
    .freq-btn:hover { border-color: #2a4a8b; background: #0f1f34; }
    
    /* Controls Section */
    .controls-section {
      margin-top: 20px; border-top: 1px solid #1a2847; padding-top: 20px;
    }
    .section-header { 
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
    }
    .section-title { font-size: 13px; font-weight: 600; color: #8b95aa; text-transform: uppercase; letter-spacing: 0.5px; }
    .toggle-advanced {
      background: transparent; border: 1px solid #1a3a6b; color: #3a9eff; padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .toggle-advanced:hover { background: rgba(58, 158, 255, 0.1); }
    
    .control-tabs {
      display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; border-bottom: 1px solid #1a2847; padding-bottom: 8px;
    }
    .control-tab {
      padding: 6px 12px; border: none; background: transparent; color: #8b95aa; cursor: pointer;
      font-size: 12px; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px;
      transition: all 0.2s;
    }
    .control-tab:hover { color: #c5cdd8; }
    .control-tab.active { color: #3a9eff; border-bottom-color: #3a9eff; }
    
    .control-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;
    }
    .control-item { margin-bottom: 0; }
    
    /* Toggle Controls */
    .control-toggle label {
      display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px 12px;
      background: #0a0e1a; border: 1px solid #1a2847; border-radius: 8px; transition: all 0.2s;
    }
    .control-toggle label:hover { background: #0f1f34; border-color: #1a3a6b; }
    .control-toggle input { width: 18px; height: 18px; cursor: pointer; accent-color: #3a9eff; }
    .control-toggle span { font-size: 13px; font-weight: 500; }
    
    /* Range & Number Controls */
    .control-range, .control-number {
      display: flex; flex-direction: column; gap: 6px;
    }
    .control-range label, .control-number label {
      font-size: 12px; font-weight: 600; color: #8b95aa;
    }
    .control-range-value { color: #3a9eff; font-size: 13px; font-weight: 600; }
    input[type="range"] {
      width: 100%; height: 5px; border-radius: 3px; background: linear-gradient(to right, #0a1726, #1a3a6b);
      border: none; cursor: pointer; -webkit-appearance: none; appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb { 
      -webkit-appearance: none; appearance: none; width: 14px; height: 14px;
      border-radius: 50%; background: #3a9eff; cursor: pointer; box-shadow: 0 0 8px rgba(58, 158, 255, 0.4);
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; height: 14px; border-radius: 50%; background: #3a9eff; cursor: pointer;
      border: none; box-shadow: 0 0 8px rgba(58, 158, 255, 0.4);
    }
    
    /* Select Controls */
    .control-select select {
      width: 100%; padding: 8px 12px; background: #0a0e1a; border: 1px solid #1a2847;
      color: #e5e7f0; border-radius: 6px; cursor: pointer;
    }
    .control-select select:focus { outline: none; border-color: #3a9eff; }
    
    /* Button Grid Controls */
    .control-button-grid {
      display: grid;
      gap: 6px;
      grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    }
    .control-button-grid button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #1a3a6b;
      background: #0a0e1a;
      color: #8b95aa;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s;
    }
    .control-button-grid button:hover {
      border-color: #2a6aaa;
      color: #c5cdd8;
    }
    .control-button-grid button.active {
      border-color: #3a9eff;
      background: rgba(58, 158, 255, 0.2);
      color: #3a9eff;
      font-weight: 600;
    }
    
    /* PTT Button */
    .ptt-button { 
      width: 100%; padding: 16px; border-radius: 10px; border: 2px solid #1a3a6b;
      background: #0a1726; color: #c5cdd8; font-size: 16px; font-weight: 600; cursor: pointer;
      transition: all 0.1s; margin-top: 16px; user-select: none; touch-action: manipulation;
    }
    .ptt-button:hover { border-color: #2a4a8b; background: #0f1f34; }
    .ptt-button:active { transform: scale(0.98); }
    .ptt-button.tx { 
      background: linear-gradient(135deg, #cc2222, #991111); border-color: #ff3333; color: #fff;
      box-shadow: 0 0 12px rgba(255, 51, 51, 0.4);
    }
    
    /* Stats Section */
    .stats { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px;
      margin-bottom: 16px;
    }
    .stat {
      background: linear-gradient(135deg, #0a0e1a, #0f1724); border: 1px solid #1a2847;
      border-radius: 10px; padding: 14px; text-align: center;
    }
    .stat .value { font-size: 28px; font-weight: 700; color: #3a9eff; }
    .stat .label { color: #8b95aa; font-size: 11px; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* QSO Form */
    .qso-form {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
      margin-bottom: 16px;
    }
    .qso-form .form-group {
      background: #0a0e1a; padding: 10px 12px; border: 1px solid #1a2847; border-radius: 8px;
    }
    .qso-form input, .qso-form select {
      background: #0f1724; border: 1px solid #1a2847; padding: 8px;
    }
    
    /* Buttons */
    .btn {
      border: none; border-radius: 8px; padding: 10px 16px; cursor: pointer; color: #fff;
      font-weight: 500; font-size: 13px; transition: all 0.2s; user-select: none;
    }
    .btn-success { background: linear-gradient(135deg, #2a8b4c, #1f6b3c); border: 1px solid #3aab5c; }
    .btn-success:hover { background: linear-gradient(135deg, #3aab5c, #2f8b4c); }
    .btn-danger { background: linear-gradient(135deg, #c73333, #a91111); border: 1px solid #e75555; }
    .btn-danger:hover { background: linear-gradient(135deg, #e75555, #d73333); }
    .btn-primary { background: linear-gradient(135deg, #3a9eff, #1a7edd); border: 1px solid #5aafff; }
    .btn-primary:hover { background: linear-gradient(135deg, #5aafff, #3aafff); }
    .btn:active { transform: scale(0.98); }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #1a2847; }
    th { color: #8b95aa; font-weight: 600; font-size: 12px; background: #0a0e1a; }
    td { font-size: 13px; }
    tr:hover { background: rgba(58, 158, 255, 0.05); }
    
    .dupe-warning { color: #ff9933; font-weight: 600; }
    
    /* Console */
    .console {
      background: #0a0e1a; border: 1px solid #1a2847; border-radius: 8px; padding: 12px;
      height: 280px; overflow: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px;
    }
    .console-line {
      display: flex; gap: 8px; margin-bottom: 4px;
    }
    .console-time { color: #5a7a8b; }

    /* Waterfall */
    .waterfall-container {
      display: flex; flex-direction: column; gap: 12px; height: 100%;
    }
    .waterfall-header {
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
    }
    .waterfall-header h3 { margin: 0; }
    .waterfall-controls {
      display: flex; gap: 16px; align-items: center; flex-wrap: wrap; font-size: 12px;
    }
    .waterfall-controls label {
      display: flex; align-items: center; gap: 6px; cursor: pointer;
    }
    .waterfall-controls input[type="checkbox"] {
      cursor: pointer; width: 16px; height: 16px;
    }
    .waterfall-controls input[type="range"] {
      width: 80px; cursor: pointer;
    }
    .waterfall-canvas {
      border: 1px solid #1a2847; border-radius: 6px; background: #000; flex: 1;
      display: block; image-rendering: pixelated;
    }
    .waterfall-scale {
      font-size: 11px; color: #5a7a8b; text-align: center;
    }
    .scale-labels {
      display: flex; justify-content: space-around; padding: 0 4px;
    }
    
    /* Utility */
    h3 { margin: 20px 0 12px 0; font-size: 13px; font-weight: 600; color: #8b95aa; text-transform: uppercase; letter-spacing: 0.5px; }
    .dupe-check { margin-top: 6px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <h1>üìª WebCAT</h1>
      <div class="status-text">
        <span v-if="radio.connected">‚úì Connected</span>
        <span v-else>‚óã Not connected</span>
      </div>
    </div>

    <div v-if="radio.connected" class="mode-bar">
      <div class="mode-item">
        <span class="mode-sep">üì°</span>
        <span class="mode-value">{{ radio.driver }}</span>
      </div>
      <div class="mode-item">
        <span class="mode-sep">|</span>
        <span>Frequency</span>
        <span class="mode-value">{{ displayFreq }}</span>
      </div>
      <div class="mode-item">
        <span class="mode-sep">|</span>
        <span>Mode</span>
        <span class="mode-value">{{ radio.mode || '‚Äî' }}</span>
      </div>
      <div class="mode-item">
        <span class="mode-sep">|</span>
        <span class="mode-value">{{ radio.ptt ? 'üî¥ TX' : '‚ö´ RX' }}</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn" :class="{active: tab === 'radio'}" @click="tab = 'radio'">Radio Control</button>
      <button class="tab-btn" :class="{active: tab === 'log'}" @click="tab = 'log'">QSO Logging</button>
      <button class="tab-btn" :class="{active: tab === 'console'}" @click="tab = 'console'">Console</button>
    </div>

    <div v-show="tab === 'radio'" class="panel">
      <!-- Setup Section (collapsed in simple mode) -->
      <div v-if="showAdvanced" class="radio-setup">
        <div class="form-group">
          <label>Driver</label>
          <select v-model="config.driver">
            <option value="icom.ic7300">IC-7300</option>
            <option value="icom.ic9700">IC-9700</option>
            <option value="yaesu.ft991a">FT-991A</option>
            <option value="yaesu.ft857d">FT-857D</option>
          </select>
        </div>
        <div class="form-group">
          <label>Baud</label>
          <select v-model.number="config.baud">
            <option :value="9600">9600</option>
            <option :value="19200">19200</option>
            <option :value="38400">38400</option>
            <option :value="57600">57600</option>
            <option :value="115200">115200</option>
          </select>
        </div>
        <div class="form-group">
          <label>Poll (ms)</label>
          <input type="number" v-model.number="config.poll" min="50" />
        </div>
        <div class="form-group" style="justify-content: flex-end;">
          <button v-if="!radio.connected" class="btn btn-success" @click="connect">Connect</button>
          <button v-else class="btn btn-danger" @click="disconnect">Disconnect</button>
        </div>
      </div>

      <!-- Connection Button (visible in simple mode) -->
      <div v-if="!showAdvanced" style="display: flex; gap: 12px; margin-bottom: 16px;">
        <button v-if="!radio.connected" class="btn btn-success" style="flex: 1; padding: 12px;" @click="toggleAdvanced">Connect Radio</button>
        <button v-else class="btn btn-danger" style="flex: 1; padding: 12px;" @click="disconnect">Disconnect</button>
        <button class="btn btn-secondary" @click="toggleAdvanced" style="padding: 12px 16px;">‚öôÔ∏è</button>
      </div>

      <radio-panel
        :radio="radio"
        :config="config"
        :display-freq="displayFreq"
        :current-controls="currentControls || []"
        :control-values="controlValues || {}"
        @manual-read="manualRead"
        @adj-freq="adjFreq"
        @control-change="onControlChange"
        @ptt="ptt"
      ></radio-panel>
    </div>

    <div v-show="tab === 'log'" class="panel">
      <!-- Stats Row -->
      <div class="stats">
        <div class="stat">
          <div class="value">{{ stats.total }}</div>
          <div class="label">Total QSOs</div>
        </div>
        <div class="stat">
          <div class="value">{{ stats.today }}</div>
          <div class="label">Today</div>
        </div>
        <div class="stat">
          <div class="value">{{ stats.bands }}</div>
          <div class="label">Bands Worked</div>
        </div>
      </div>

      <!-- New Contact Form -->
      <h3 style="margin-bottom: 12px;">üìù New Contact</h3>
      <div class="qso-form">
        <div class="form-group" style="grid-column: span 2;">
          <label>Callsign <span style="color: #ff6b6b;">*</span></label>
          <input v-model="qso.call" @input="checkDupe" placeholder="W1AW" style="text-transform: uppercase; font-size: 16px; font-weight: 600;" />
          <span v-if="isDupe" class="dupe-warning">‚ö†Ô∏è DUPE!</span>
        </div>
        <div class="form-group">
          <label>Frequency</label>
          <input type="number" v-model.number="qso.freq" :value="radio.freq || qso.freq" placeholder="Hz" />
        </div>
        <div class="form-group">
          <label>Mode</label>
          <input v-model="qso.mode" :value="radio.mode || qso.mode" placeholder="SSB/CW/FT8" style="text-transform: uppercase;" />
        </div>
        <div class="form-group">
          <label>RST Sent</label>
          <input v-model="qso.rst_sent" placeholder="599" style="text-align: center; font-weight: 600; font-size: 14px;" />
        </div>
        <div class="form-group">
          <label>RST Rcvd</label>
          <input v-model="qso.rst_rcvd" placeholder="599" style="text-align: center; font-weight: 600; font-size: 14px;" />
        </div>
        <div class="form-group">
          <label>Operator</label>
          <input v-model="qso.operator" placeholder="K1ABC" style="text-transform: uppercase;" />
        </div>
      </div>

      <button class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 15px; font-weight: 600; margin-bottom: 24px;" @click="logQSO">üìù Log Contact</button>

      <!-- Recent QSOs -->
      <h3 style="margin-bottom: 12px;">üìã Recent QSOs</h3>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Call</th>
              <th>Freq</th>
              <th>Mode</th>
              <th>RST</th>
              <th>Op</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="q in qsos" :key="q.id">
              <td style="font-size: 12px;">{{ formatTime(q.timestamp) }}</td>
              <td><strong style="font-size: 14px;">{{ q.call }}</strong></td>
              <td style="font-size: 12px;">{{ formatFreq(q.freq) }}</td>
              <td style="font-size: 12px; text-transform: uppercase;">{{ q.mode }}</td>
              <td style="font-size: 12px;">{{ q.rst_sent }}/{{ q.rst_rcvd }}</td>
              <td style="font-size: 12px;">{{ q.operator }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-show="tab === 'console'" class="panel">
      <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
        <span style="color: #8b95aa; font-size: 13px;">{{ logs.length }} messages</span>
        <button class="btn btn-secondary" style="margin-left: auto;" @click="logs = []">Clear Console</button>
      </div>
      <div class="console">
        <div v-if="logs.length === 0" style="color: #5a7a8b; text-align: center; padding: 20px; font-size: 13px;">
          No log messages yet...
        </div>
        <div v-for="(log, i) in logs.slice(-200)" :key="i" class="console-line">
          <span class="console-time">[{{ log.time }}]</span>
          <span>{{ log.msg }}</span>
        </div>
      </div>
    </div>
  </div>

  <script src="webcat-base.js"></script>
  <script src="drivers/webcat-icom-ic7300.js"></script>
  <script src="drivers/webcat-icom-ic9700.js"></script>
  <script src="drivers/webcat-yaesu-ft991a.js"></script>
  <script src="drivers/webcat-yaesu-ft857d.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      components: {
        RadioPanel: window.RadioPanel,
        QSOForm: window.QSOForm,
        ConsolePanel: window.ConsolePanel
      },
      data() {
        return {
          tab: 'radio',
          stationId: 'STATION',
          showAdvanced: false,
          config: { driver: 'icom.ic7300', baud: 19200, poll: 200 },
          radio: { connected: false, ctrl: null, driver: '', freq: 0, mode: '', ptt: false, state: {} },
          qso: { call: '', freq: 0, mode: '', rst_sent: '59', rst_rcvd: '59', operator: '' },
          qsos: [],
          stats: { total: 0, today: 0, bands: 0 },
          logs: [],
          isDupe: false,
          controlValues: {},
          controls: []
        };
      },
      computed: {
        displayFreq() {
          const mhz = Math.floor(this.radio.freq / 1000000);
          const khz = Math.floor((this.radio.freq % 1000000) / 1000);
          const hz = this.radio.freq % 1000;
          return `${mhz}.${String(khz).padStart(3, '0')}.${String(hz).padStart(3, '0')}`;
        },
        currentControls() { return this.controls; }
      },
      mounted() {
        fetch('/api/health').then(r => r.json()).then(d => this.stationId = d.stationId).catch(() => {});
        this.loadQSOs();
        this.updateBaudFromDriver();
      },
      watch: {
        'config.driver'() {
          this.updateBaudFromDriver();
        }
      },
      methods: {
        toggleAdvanced() {
          this.showAdvanced = !this.showAdvanced;
        },
        updateBaudFromDriver() {
          const meta = WebCAT.getDriverMeta(this.config.driver);
          if (meta && meta.defaultBaud) {
            this.config.baud = meta.defaultBaud;
          }
        },
        async connect() {
          try {
            this.radio.ctrl = new WebCAT.RadioController({ driverId: this.config.driver, verbose: true });
            this.radio.driver = this.config.driver;
            this.radio.ctrl.on('log', m => this.log(m));
            this.radio.ctrl.on('update', s => this.onState(s));
            this.radio.ctrl.on('error', e => this.log('‚ùå ' + e.message));
            this.radio.ctrl.on('connected', () => this.log('‚úì Serial connected'));
            this.radio.ctrl.on('disconnected', () => this.log('‚úó Serial disconnected'));

            await this.radio.ctrl.connectWithPicker({ baudRate: this.config.baud });
            this.radio.connected = true;
            
            // Load control schema from driver
            console.log('Radio controller:', this.radio.ctrl);
            console.log('Driver instance:', this.radio.ctrl.driver);
            console.log('Driver has controlsSchema:', typeof this.radio.ctrl?.driver?.controlsSchema);
            
            const schema = this.radio.ctrl?.driver?.controlsSchema?.();
            console.log('Schema result:', schema);
            
            // Direct array assignment + force update
            this.controls = Array.isArray(schema) ? [...schema] : [];
            this.controlValues = {};
            this.$forceUpdate();
            
            console.log('Controls assigned:', this.controls.length);
            console.log('CurrentControls:', this.currentControls.length);

            this.radio.ctrl.startPolling(this.config.poll);
            this.log('‚úì Connected to ' + this.config.driver);
          } catch (e) {
            this.log('‚úó Failed: ' + e.message);
            alert('Connection failed: ' + e.message);
          }
        },
        disconnect() {
          if (this.radio.ctrl) {
            this.radio.ctrl.disconnect();
            this.radio.ctrl = null;
          }
          this.radio.connected = false;
          this.controls = [];
          this.log('Disconnected');
        },
        onState(s) {
          this.radio.freq = s.freqHz || this.radio.freq;
          this.radio.mode = s.mode || this.radio.mode;
          this.radio.ptt = s.ptt || false;
          this.radio.state = s;

          if (this.radio.freq) this.qso.freq = this.radio.freq;
          if (this.radio.mode) this.qso.mode = this.radio.mode;

          this.updateControlDisplayValues();
        },
        updateControlDisplayValues() {
          const updated = { ...this.controlValues };
          this.controls.forEach(ctrl => {
            if (typeof ctrl.read === 'function') {
              try {
                const value = ctrl.read(this.radio.state);
                if (value !== undefined) {
                  updated[ctrl.id] = value;
                }
              } catch (e) {
                this.log(`Error reading ${ctrl.id}: ${e.message}`);
              }
            }
          });
          this.controlValues = updated;
        },
        async onControlChange(ctrl, newValue) {
          if (!this.radio.ctrl) return;
          try {
            if (typeof ctrl.apply === 'function') {
              await ctrl.apply(this.radio.ctrl, newValue);
              this.log(`Set ${ctrl.label} = ${newValue}`);
            }
          } catch (e) {
            this.log(`Error: ${e.message}`);
          }
        },
        async adjFreq(delta) {
          if (!this.radio.ctrl) return;
          const f = Math.max(0, (this.radio.freq || 0) + delta);
          await this.radio.ctrl.setFrequencyHz(f);
        },
        async manualRead() {
          if (!this.radio.ctrl || !this.radio.ctrl.driver) return;
          this.log('‚Üí Manual read triggered');
          try {
            if (typeof this.radio.ctrl.driver.cmdReadFreq === 'function') {
              const cmd = this.radio.ctrl.driver.cmdReadFreq();
              await this.radio.ctrl.sendCommand(cmd);
            }
          } catch (e) {
            this.log('Manual read error: ' + e.message);
          }
        },
        async ptt(on) {
          if (this.radio.ctrl) await this.radio.ctrl.setPTT(on);
        },
        async logQSO() {
          if (!this.qso.call.trim()) { alert('Callsign required'); return; }
          try {
            const res = await fetch('/api/qsos', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                call: this.qso.call.toUpperCase(),
                freq: this.qso.freq || this.radio.freq,
                mode: this.qso.mode || this.radio.mode,
                rst_sent: this.qso.rst_sent,
                rst_rcvd: this.qso.rst_rcvd,
                operator: this.qso.operator,
                timestamp: new Date().toISOString()
              })
            });
            if (res.ok) {
              this.log('Logged: ' + this.qso.call);
              this.qso.call = '';
              this.qso.operator = '';
              this.isDupe = false;
              this.loadQSOs();
            } else {
              this.log('Log failed');
            }
          } catch (e) {
            alert('Log error: ' + e.message);
          }
        },
        async checkDupe() {
          if (this.qso.call.length < 2) { this.isDupe = false; return; }
          try {
            const res = await fetch(`/api/qsos/dupe/${this.qso.call.toUpperCase()}`);
            const data = await res.json();
            this.isDupe = data.dupe;
          } catch {
            this.isDupe = false;
          }
        },
        async loadQSOs() {
          try {
            const res = await fetch('/api/qsos?limit=50');
            const data = await res.json();
            if (data.ok) {
              this.qsos = data.qsos;
              this.stats.total = data.total;
              const today = new Date().toISOString().split('T')[0];
              this.stats.today = data.qsos.filter(q => q.timestamp.startsWith(today)).length;
              this.stats.bands = new Set(data.qsos.map(q => {
                const mhz = q.freq / 1000000;
                if (mhz >= 1.8 && mhz < 2) return '160';
                if (mhz >= 3.5 && mhz < 4) return '80';
                if (mhz >= 7 && mhz < 7.3) return '40';
                if (mhz >= 14 && mhz < 14.35) return '20';
                if (mhz >= 21 && mhz < 21.45) return '15';
                if (mhz >= 28 && mhz < 29.7) return '10';
                return 'Other';
              })).size;
            }
          } catch (e) {
            this.log('Load error: ' + e.message);
          }
        },
        log(msg) {
          if (this.logs.length >= 500) {
            this.logs.shift();
          }
          this.logs.push({
            time: new Date().toLocaleTimeString(),
            msg: String(msg).substring(0, 200)
          });
        },
        formatTime(ts) {
          return new Date(ts).toLocaleTimeString();
        },
        formatFreq(f) {
          return (f / 1000000).toFixed(3) + ' MHz';
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
